<<<<<<< HEAD
﻿using System.Collections.Generic;
using System.Data;
using System.Linq;
using Dapper;
using DevEdu.Core;
using DevEdu.DAL.Enums;
using DevEdu.DAL.Models;
using Microsoft.Extensions.Options;
=======
﻿using Dapper;
using DevEdu.DAL.Enums;
using DevEdu.DAL.Models;
using System.Collections.Generic;
using System.Data;
using System.Linq;
>>>>>>> main

namespace DevEdu.DAL.Repositories
{
    public class CommentRepository : BaseRepository, ICommentRepository
    {
        private const string _commentAddProcedure = "dbo.Comment_Insert";
        private const string _commentDeleteProcedure = "dbo.Comment_Delete";
        private const string _commentSelectByIdProcedure = "dbo.Comment_SelectById";
<<<<<<< HEAD
        private const string _commentSelectAllByUserIdProcedure = "dbo.Comment_SelectAllByUserId";
        private const string _commentUpdateProcedure = "dbo.Comment_Update";
        private const string _commentsFromLessonSelectByLessonIdProcedure = "dbo.Comment_SelectByLessonId";

        public CommentRepository(IOptions<DatabaseSettings> options) : base(options){ }

        public int AddComment(CommentDto commentDto)
=======
        private const string _commentUpdateProcedure = "dbo.Comment_Update";
        private const string _commentsFromLessonSelectByLessonIdProcedure = "dbo.Comment_SelectByLessonId";

        public CommentRepository() { }

        public int AddComment(CommentDto dto)
>>>>>>> main
        {
            return _connection.QuerySingle<int>(
                _commentAddProcedure,
                new
                {
<<<<<<< HEAD
                    userId = commentDto.User.Id,
                    commentDto.Text
=======
                    userId = dto.User.Id,
                    lessonId = dto.Lesson == null ? null : (int?)dto.Lesson.Id,
                    studentHomeworkId = dto.StudentHomework == null ? null : (int?)dto.StudentHomework.Id,
                    dto.Text
>>>>>>> main
                },
                commandType: CommandType.StoredProcedure
            );
        }

        public void DeleteComment(int id)
        {
            _connection.Execute(
                _commentDeleteProcedure,
                new { id },
                commandType: CommandType.StoredProcedure
            );
        }

        public CommentDto GetComment(int id)
        {
            CommentDto result = default;
            return _connection
<<<<<<< HEAD
                .Query<CommentDto, UserDto, Role, CommentDto>(
                    _commentSelectByIdProcedure,
                    (comment, user, role) =>
=======
                .Query<CommentDto, UserDto, Role, LessonDto, StudentHomeworkDto, CommentDto>(
                    _commentSelectByIdProcedure,
                    (comment, user, role, lesson, studentHomework) =>
>>>>>>> main
                    {
                        if (result == null)
                        {
                            result = comment;
                            result.User = user;
                            result.User.Roles = new List<Role> { role };
<<<<<<< HEAD
=======
                            result.Lesson = lesson;
                            result.StudentHomework = studentHomework;
>>>>>>> main
                        }
                        else
                        {
                            result.User.Roles.Add(role);
                        }
                        return result;
                    },
                    new { id },
                    splitOn: "Id",
                    commandType: CommandType.StoredProcedure
                )
                .FirstOrDefault();
        }

<<<<<<< HEAD
        public List<CommentDto> GetCommentsByUser(int userId)
        {
            var commentDictionary = new Dictionary<int, CommentDto>();
            CommentDto result;

            return _connection
                .Query<CommentDto, UserDto, Role, CommentDto>(
                    _commentSelectAllByUserIdProcedure,
                    (comment, user, role) =>
                    {

                        if (!commentDictionary.TryGetValue(comment.Id, out result))
                        {
                            result = comment;
                            result.User = user;
                            result.User.Roles = new List<Role> { role };
                            commentDictionary.Add(comment.Id, result);
                        }
                        else
                        {
                            result.User.Roles.Add(role);
                        }

                        return result;
                    },
                    new { userId },
                    splitOn: "Id",
                    commandType: CommandType.StoredProcedure
                )
                .Distinct()
                .ToList();
        }

        public void UpdateComment(CommentDto commentDto)
=======
        public void UpdateComment(CommentDto dto)
>>>>>>> main
        {
            _connection.Execute(
                _commentUpdateProcedure,
                new
                {
<<<<<<< HEAD
                    commentDto.Id,
                    commentDto.Text
=======
                    dto.Id,
                    dto.Text
>>>>>>> main
                },
                commandType: CommandType.StoredProcedure
            );
        }

        public List<CommentDto> SelectCommentsFromLessonByLessonId(int lessonId)
        {
<<<<<<< HEAD
            return _connection
                .Query<CommentDto>(
                    _commentsFromLessonSelectByLessonIdProcedure,
=======
            CommentDto result = default;
            return _connection
                .Query<CommentDto, UserDto, CommentDto>(
                    _commentsFromLessonSelectByLessonIdProcedure,
                    (comment, user) =>
                    {
                        result = comment;
                        result.User = user;
                        return result;
                    },
>>>>>>> main
                    new { lessonId },
                    commandType: CommandType.StoredProcedure
                )
                .Distinct()
                .ToList();
        }
    }
}